#Errors encountered when executing a nextflow pipeline on a cluster which makes use of local singularity images.

Cluster: PBS 
[21616019@hpc2 ~/git_projects/PSA_framework]$ qstat --version
pbs_version = 2021.1.2.20210913160841
Local execution occurs without error.
________________________________________________________________________________
Error encountered:

WARN: [PBS] queue (bix) status cannot be fetched
- cmd executed: bash -c set -o pipefail; qstat -f -1 bix | { grep -E '(Job Id:|job_state =)' || true; }
- exit status : 2
- output      :
  qstat: conflicting options.
  usage: 
  qstat [-f] [-J] [-p] [-t] [-x] [-E] [-F format | -w] [-D delim] [ job_identifier... | destination... ]
  qstat [-a|-i|-r|-H|-T] [-J] [-t] [-u user] [-n] [-s] [-G|-M] [-1] [-w]
  	[ job_identifier... | destination... ]
  qstat -Q [-f] [-F format] [-D delim] [ destination... ]
  qstat -q [-G|-M] [ destination... ]
  qstat -B [-f] [-F format] [-D delim] [ server_name... ]
  qstat --version
  
Solution:
The above error is due to the process executor being specified as 'pbs' in place of 'pbspro'.
Snippet below is from nextflow.config file.
    cluster_PBS {
        // Configuration for a cluster (e.g., SLURM, PBS)
        process.executor = 'pbspro'
        process.queue = 'bix'
        process.cpus = 8
        process.memory = '16GB'
        process.time = '12h'
    }
Link to forum with suggested solution:
https://github.com/nextflow-io/nextflow/issues/1106

Nextflow docs:
https://www.nextflow.io/docs/latest/executor.html#pbs-pro
________________________________________________________________________________
Error encountered:

Command error:
  env: 'singularity': No such file or directory

The above error occured even when the module was loaded within the pbs script that launched nextflow.
It seemed that the qsub commands that nextflow was executing to run the processes was not able to access the modules loaded in the pbs script used to launch nextflow.

Solution:
By making use the beforeScript directive within the process scope of the configuration file to load the necessary module, the processes were able to find the command singularity.
Below is a snippet from the nextflow.config file
	process {
		beforeScript = 'module load app/apptainer/1.2.5'

		withName:ROSETTA_FIXBB {
		    container = 'images/rosetta_23_45_updated_03.sif'
		}
		withName:ROSETTA_THREADER {
		    container = 'images/rosetta_23_45_updated_03.sif'
		}
		withName:MAESTRO {
		    container = 'images/maestro.sif'
		}
		withName:GROMACS_MT_THREADER {
		    container = 'images/gromacs2023_2_mpi_charmm36m.sif'
		}
		withName:GROMACS_MT_FBB {
		    container = 'images/gromacs2023_2_mpi_charmm36m.sif'
		}
		withName:GROMACS_WT {
		    container = 'images/gromacs2023_2_mpi_charmm36m.sif'
		}
	}

 
Link to forum with suggested solution:
https://github.com/nf-core/mag/issues/234
https://github.com/nf-core/ampliseq/issues/581

Nextflow docs:
https://www.nextflow.io/docs/latest/process.html#beforescript

